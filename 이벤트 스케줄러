-- 이벤트 스케줄러 확인
SHOW VARIABLES LIKE 'event%';

-- 이벤트 스케줄러 켜기
SET GLOBAL event_scheduler = ON;

-- 생성되어 있는 이벤트 스케줄러 확인
SELECT * FROM information_schema.events;

-- 예약완료 > 사용완료 변경 이벤트 스케줄러 생성
CREATE EVENT IF NOT EXISTS UPDATE_RESERVATION_STATUS
ON SCHEDULE EVERY 1 DAY
STARTS NOW() 
DO
    UPDATE RESERVATION
    SET RESERVATION_STATUS = '사용완료'
    WHERE RESERVATION_STATUS = '예약완료'
    AND RESERVATION_REGISTRATION_DATE < CURDATE();

-- 신고 3번 이상 당한 멤버 비활성화 이벤트 스케줄러
CREATE EVENT IF NOT EXISTS UPDATE_BANNED_MEMBER
ON SCHEDULE EVERY 1 hour
STARTS NOW()
DO
UPDATE MEMBER AS M
SET M.MEMBER_ROLE = 'BANNED'
WHERE (
      SELECT COUNT(*)
      FROM CLAIM AS C
      WHERE C.CLAIM_TARGET_MEMBER_ID = M.MEMBER_ID
        AND C.CLAIM_STATUS = 'COMPLETED'
  ) >= 3;

-- 이벤트 스케줄러 삭제
DROP event UPDATE_RESERVATION_STATUS;
DROP event UPDATE_BANNED_MEMBER;


